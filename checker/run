#!/bin/sh

set -ex

. $(dirname "$0")/../options

if [ -z "$url" ] | [ -z "$pattern" ] | [ -z "$message" ]; then
    echo "Required fields url, pattern and message not found in ../options"
    exit 1
fi

content=$(curl "$url")

new_value=$(echo "$content" | grep -oP "$pattern" | head -1)

if [ -z "$new_value" ]; then
    echo "Expected pattern $pattern not found in $url"
    exit 1
fi

trap 'echo $new_value | tee $cfg_dir/old_value' HUP INT TERM EXIT

old_value=$(cat "$cfg_dir"/old_value || echo "")

if [ "$new_value" != "$old_value" ]; then
    git commit --allow-empty -m "$message ($new_value)"
    git push
fi
