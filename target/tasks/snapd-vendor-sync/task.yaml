summary: Mirror snapd adding go dependencies

environment:
    CREDENTIALS_FILE: /tmp/id_rsa
    TARGET_DIR:  $GOPATH/src/snapd-plus-vendor-target

prepare: |
    mv id_rsa /tmp

    sysctl -w net.ipv6.conf.all.disable_ipv6=1
    trap "sysctl -w net.ipv6.conf.all.disable_ipv6=0" EXIT
    apt update && apt install -y git golang-1.6 openssh-client jq

    go get -u github.com/kardianos/govendor

    chmod 0600 $CREDENTIALS_FILE

restore: |
    rm -f $CREDENTIALS_FILE
    rm -rf origin $TARGET_DIR

    apt remove -y git golang-1.6 openssh-client jq

execute: |
    # get origin merge commit
    #message="sync snapd-vendor with snapd after merge and green build"
    #build_number=$(echo "$TRAVIS_COMMIT_MESSAGE" | sed -e "s/$message (\(.*\))/\1/")
    #origin_commit=$(curl -s https://api.travis-ci.org/repos/snapcore/snapd/builds?number=$build_number | jq -j '.[0].commit')

    # clone origin repo and prepare for getting vendor dependencies
    git clone https://github.com/snapcore/snapd origin
    cd origin
    #git reset --hard $origin_commit
    rm -rf .git
    sed -i 's|^vendor/\*/$||' .gitignore
    cd ..

    # clone target repo and copy origin over target
    eval `ssh-agent -s`
    mkdir -p ${HOME}/.ssh && ssh-keyscan -t rsa git.launchpad.net >> ~/.ssh/known_hosts
    ssh-agent $(ssh-add $CREDENTIALS_FILE; git clone git+ssh://snappy-m-o@git.launchpad.net/snapd-vendor $TARGET_DIR)
    cp -ar origin/. $TARGET_DIR

    # configure git locally
    cd $TARGET_DIR
    git config user.name "Snappy Developers"
    git config user.email snappy-dev@lists.launchpad.net

    # get vendor dependencies on target repo
    govendor sync

    if [ $(git ls-files -dmo | wc -l) != "0" ]; then
        # if something was deleted, changed or added commit and push to the target repo
        git add .
        # guard against commited and later ignored files..
        if git commit -am"Content updated ($origin_commit)"; then
            ssh-agent $(ssh-add $CREDENTIALS_FILE; git push)
        fi
    fi
